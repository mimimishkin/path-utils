package path.utils.paths

import path.utils.math.Tolerance
import path.utils.math.Vec2
import path.utils.math.near
import kotlin.random.Random
import kotlin.test.Test

class TransformedPathKtTest {
    private val path = path("M4 8 10 1 13 0 12 3 5 9C6 10 6 11 7 10 7 11 8 12 7 12A1.42 1.42 0 016 13 5 5 0 004 10Q3.5 9.9 3.5 10.5T2 11.8 1.2 11 2.5 9.5 3 9A5 5 90 000 7 1.42 1.42 0 011 6C1 5 2 6 3 6 2 7 3 7 4 8M10 1 10 3 12 3 10.2 2.8 10 1")
    val trueScaled = path("M 0.0706260825363211885985492699546739459038 2.6361467976483501374218576529528945684433 L 0.1765652063408029714963731748866848647594 0.3295183497060437671777322066191118210554 L 0.2295347682430438629452851273526903241873 0 L 0.2118782476089635657956478098640218377113 0.9885550491181313015331966198573354631662 L 0.0882826031704014857481865874433424323797 2.9656651473543940156218923220876604318619 C 0.1059391238044817828978239049320109188557 3.2951834970604378938219269912224262952805 0.1059391238044817828978239049320109188557 3.6247018467664813279327518102945759892464 0.1235956444385620800474612224206794053316 3.2951834970604378938219269912224262952805 C 0.1235956444385620800474612224206794053316 3.6247018467664813279327518102945759892464 0.1412521650726423771970985399093478918076 3.9542201964725252061327864794293418526649 0.1235956444385620800474612224206794053316 3.9542201964725252061327864794293418526649 A 0.4679160565825821738172862751525826752186 0.0250722593003942367806402558016998227686 90 0 1 0.1059391238044817828978239049320109188557 4.2837385461785686402436112985014915466309 A 1.6475917485302189469109634956112131476402 0.0882826031704011943146426233397505711764 90 0 0 0.0706260825363211885985492699546739459038 3.2951834970604378938219269912224262952805 Q 0.0617978222192810400237306112103397026658 3.2622316620898335060019235243089497089386 0.0617978222192810400237306112103397026658 3.4599426719134593888327344757271930575371 T 0.0353130412681605942992746349773369729519 3.8883165265313168745819893956650048494339 T 0.0211878247608963572734541713771250215359 3.6247018467664813279327518102945759892464 T 0.0441413015852007428740932937216712161899 3.1304243222074159547219096566550433635712 T 0.0529695619022408914489119524660054594278 2.9656651473543940156218923220876604318619 A 1.6475917485302189469109634956112131476402 0.0882826031704011943146426233397505711764 90 0 0 0 2.3066284479423062592218229838181287050247 A 0.4679160565825821738172862751525826752186 0.0250722593003942367806402558016998227686 90 0 1 0.0176565206340802971496373174886684864759 1.9771100982362626030663932397146709263325 C 0.0176565206340802971496373174886684864759 1.6475917485302189469109634956112131476402 0.0353130412681605942992746349773369729519 1.9771100982362626030663932397146709263325 0.0529695619022408914489119524660054594278 1.9771100982362626030663932397146709263325 C 0.0353130412681605942992746349773369729519 2.3066284479423062592218229838181287050247 0.0529695619022408914489119524660054594278 2.3066284479423062592218229838181287050247 0.0706260825363211885985492699546739459038 2.6361467976483501374218576529528945684433 M 0.1765652063408029714963731748866848647594 0.3295183497060437671777322066191118210554 L 0.1765652063408029714963731748866848647594 0.9885550491181313015331966198573354631662 L 0.2118782476089635657956478098640218377113 0.9885550491181313015331966198573354631662 L 0.1800965104676190142729552690070704557002 0.9226513791769225258931896860303822904825 L 0.1765652063408029714963731748866848647594 0.3295183497060437671777322066191118210554")

    @Test
    fun translate() {
        val (x, y, w, h) = path.bounds
        val tx = Random.nextDouble()
        val ty = Random.nextDouble()
        val (nx, ny, nw, nh) = path.translate(tx, ty).bounds

        assert(x + tx near nx)
        assert(y + ty near ny)
        assert(w near nw)
        assert(h near nh)
    }

    @Test
    fun scale() {
        val random = Random(4642)
        val sx = random.nextDouble()
        val sy = random.nextDouble()
        val scaled = path.scale(sx, sy)

        Tolerance = 1e-5
        assert(scaled.zip(trueScaled).all { (value: Command, expected: Command) ->
            value.arguments.zip(expected.arguments).all { it.first near it.second }
        })
    }

    @Test
    fun scaleWithAnchor() {
        val random = Random(4642)
        val sx = random.nextDouble()
        val sy = random.nextDouble()
        val cx = random.nextDouble()
        val cy = random.nextDouble()
        val scaled = path.scale(sx, sy, anchor = Vec2(cx, cy))
        val scaled2 = path.translate(-cx, -cy).scale(sx, sy).translate(cx, cy)

        assert(scaled.zip(scaled2).all { (value: Command, expected: Command) ->
            value.arguments.zip(expected.arguments).all { it.first near it.second }
        })
    }
}